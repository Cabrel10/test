#!/usr/bin/make -f
# @configure_input@
## =============================================================================
## 
# @(#) rules.in,v OpenSS7-0_9_2_D_rc2(0.9.2.6) 2006/07/08 07:23:02
##
## -----------------------------------------------------------------------------
##
## Copyright (c) 2001-2006  OpenSS7 Corporation <http://www.openss7.com/>
## Copyright (c) 1997-2000  Brian F. G. Bidulock <bidulock@openss7.org>
##
## All Rights Reserved.
##
## This program is free software; you can redistribute it and/or modify it under
## the terms of the GNU General Public License as published by the Free Software
## Foundation; version 2 of the License.
##
## This program is distributed in the hope that it will be useful, but WITHOUT
## ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
## FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
## details.
##
## You should have received a copy of the GNU General Public License along with
## this program; if not, write to the Free Software Foundation, Inc., 675 Mass
## Ave, Cambridge, MA 02139, USA.
##
## -----------------------------------------------------------------------------
##
## U.S. GOVERNMENT RESTRICTED RIGHTS.  If you are licensing this Software on
## behalf of the U.S. Government ("Government"), the following provisions apply
## to you.  If the Software is supplied by the Department of Defense ("DoD"), it
## is classified as "Commercial Computer Software" under paragraph 252.227-7014
## of the DoD Supplement to the Federal Acquisition Regulations ("DFARS") (or any
## successor regulations) and the Government is acquiring only the license rights
## granted herein (the license rights customarily provided to non-Government
## users).  If the Software is supplied to any unit or agency of the Government
## other than DoD, it is classified as "Restricted Computer Software" and the
## Government's rights in the Software are defined in paragraph 52.227-19 of the
## Federal Acquisition Regulations ("FAR") (or any successor regulations) or, in
## the cases of NASA, in paragraph 18.52.227-86 of the NASA Supplement to the FAR
## (or any successor regulations).
##
## -----------------------------------------------------------------------------
##
## Commercial licensing and support of this software is available from OpenSS7
## Corporation at a fee.  See http://www.openss7.com/
##
## -----------------------------------------------------------------------------
##
## Last Modified 2006/07/08 07:23:02 by brian
##
## =============================================================================

CC = @CC@
CPP = @CPP@
CXX = @CXX@
CXXCPP = @CXXCPP@

PACKAGE = @PACKAGE@
PACKAGE_LCNAME = @PACKAGE_LCNAME@
VERSION = @VERSION@

srcdir=.
debbuilddir = ..
debtmpdir = debian/tmp
PACKAGE_DEBOPTIONS = @PACKAGE_DEBOPTIONS@

rootdir = @rootdir@
kversion = @kversion@
krelease = @krelease@
kmoduledir = @kmoduledir@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
sbindir = @sbindir@
sysconfdir = @sysconfdir@
datadir = @datadir@
includedir = @includedir@
libdir = @libdir@
libexecdir = @libexecdir@
localstatedir = @localstatedir@
sharedstatedir = @sharedstatedir@
mandir = @mandir@
infodir = @infodir@
oldincludedir = @oldincludedir@

configdir = @configdir@
initrddir = @initrddir@
modutildir = @modutildir@

pkgdatadir = $(datadir)/$(PACKAGE)
pkglibdir = $(libdir)/$(PACKAGE)
pkgincludedir = $(includedir)/$(PACKAGE)
pkglibexecdir = $(libexecdir)/$(PACKAGE)

export DEB_HOST_ARCH
export DH_VERBOSE = 1
export DH_COMPAT = 4
export DH_OPTIONS =
export BUILD_CFGOPTIONS = '--with-lfs --without-lis'

name = $(PACKAGE)
epoch = @PACKAGE_RPMEPOCH@
base = @PACKAGE_LCNAME@
title = @PACKAGE_TITLE@
stitle = @PACKAGE_SHORTTITLE@

kernel_version=@kversion@
kernel_number=$(shell echo $(kversion) | sed -e s',-.*$,,')
kernel_release=$(shell echo $(kversion) | sed -e s',-,.,g')
core_name = core-$(VERSION)
info_name = info-$(VERSION)
majbase = @STRCONF_MAJBASE@
makedev = @STRCONF_MAKEDEV@

modules = streams-aixcompat streams-hpuxcompat streams-irixcompat streams-liscompat streams-maccompat streams-mpscompat streams-osfcompat streams-solcompat streams-suxcompat streams-sux compat streams-svr3compat streams-svr4compat streams-uw7compat streams-uxpcompat
preloads =
libraries =
tools = strcompat_mknod
infofiles = $(name)
initfiles = 

@WITH_KO_MODULES_TRUE@with_ko_modules = 1
@WITH_KO_MODULES_FALSE@with_ko_modules = 0

have_init_files = 0
have_libraries = 0
have_preloads = 0

control =


cache_file=$(debbuilddir)/$(DEB_HOST_ARCH)-$(kversion)-config.cache
csite_file=$(debbuilddir)/$(DEB_HOST_ARCH)-config.site
mpost_file=$(debbuilddir)/$(DEB_HOST_ARCH)-$(kversion)-modpost.cache

build:
	@echo "Target $@ invoked in `pwd` with DH_OPTIONS='$(DH_OPTIONS)'"
	dh_testdir -v
	rm -fr $(PACKAGE)-$(VERSION)
	[ ! -f Makefile ] || $(MAKE) distclean
	rm -f $(control)
	./configure \
		CC='$(CC)' \
		CFLAGS='$(CFLAGS)' \
		LDFLAGS='$(LDFLAGS)' \
		CPPFLAGS='$(CPPFLAGS)' \
		CPP='$(CPP)' \
		CXX='$(CXX)' \
		CXXFLAGS='$(CXXFLAGS)' \
		CXXCPP='$(CXXCPP)' \
		CONFIG_SITE="$(csite_file)" \
		MODPOST_CACHE="$(mpost_file)" \
		--cache-file="$(cache_file)" \
		--host="$(DEB_HOST_GNU_ARCH)" \
		--prefix=$(prefix) \
		--exec_prefix=$(exec_prefix) \
		--bindir=$(bindir) \
		--sbindir=$(sbindir) \
		--sysconfdir=$(sysconfdir) \
		--datadir=$(datadir) \
		--includedir=$(includedir) \
		--libdir=$(libdir) \
		--libexecdir=$(libexecdir) \
		--localstatedir=$(localstatedir) \
		--sharedstatedir=$(sharedstatedir) \
		--mandir=$(mandir) \
		--infodir=$(infodir) \
		--disable-maintainer-mode \
		--disable-dependency-tracking \
		--with-gnu-ld \
		--with-k-release=$(kversion) \
		--with-k-modules=$(kmoduledir) \
		--with-base-major=$(majbase) \
		$(PACKAGE_DEBOPTIONS) \
		$(BUILD_CFGOPTIONS) \
		|| { rm -f $(cache_file) ; exit 1 ; }
	$(MAKE)
	mkdir -p $(PACKAGE)-$(VERSION)
	tar cf - --exclude=$(debtmpdir) --exclude=$(PACKAGE)-$(VERSION) . | \
	tar xf - -C $(PACKAGE)-$(VERSION)
	$(MAKE) check check-clean
	chmod +x debian/rules

clean:
	@echo "Target $@ invoked in `pwd` with DH_OPTIONS='$(DH_OPTIONS)'"
	dh_testdir -v
	dh_testroot -v
	rm -fr $(PACKAGE)-$(VERSION)
	[ ! -f Makefile ] || $(MAKE) distclean
	rm -f $(control)
	rm -fr $(debtmpdir)
	dh_clean -v -k

install:
	@echo "Target $@ invoked in `pwd` with DH_OPTIONS='$(DH_OPTIONS)'"
	dh_testdir -v
	dh_testroot -v
	dh_clean -v -k
	dh_installdirs -v
	$(MAKE) DESTDIR=`pwd`/$(debtmpdir) install
	$(MAKE) -f debian/rules $(control)
	dh_install -v --list-missing

binary-common:
	@echo "Target $@ invoked in `pwd` with DH_OPTIONS='$(DH_OPTIONS)'"
	dh_testdir -v
	dh_testroot -v
	dh_installmodules -v
	dh_installchangelogs -v
	dh_installdocs -v debian/README.Debian debian/TODO.Debian
	dh_installdebconf -v
#	dh_installinit -v --init-script=$(PACKAGE_LCNAME).sh -- start 33 S . stop 33 0 6 .
	dh_installman -v
	dh_installinfo -v
	dh_strip -v
	dh_link -v
	dh_compress -v -X$(PACKAGE_LCNAME).macros -X$(PACKAGE_LCNAME).refs
	dh_fixperms -v
	dh_makeshlibs -v
	dh_installdeb -v
	dh_shlibdeps -v -X.ko -X.o
	dh_gencontrol -v $(dversion)
	dh_md5sums -v
	dh_builddeb -v

#
#  dkpg-buildpackage invoke this makefile in one of two ways: with the -b flag,
#  the 'binary' target is invoked to build both arch and indep binary packages;
#  with the -B flag, the 'binary-arch' target is invoked to build only the arch
#  binary packages and not the indep binary packages.  We further distinguish
#  arch packages as being for lis, for lfs, or we don't care based on the
#  setting of the passed in BUILD_CFGOPTIONS environment variable.
#
binary-indep: DH_OPTIONS = -i
binary-indep: install
	@echo "Target $@ invoked in `pwd` with DH_OPTIONS='$(DH_OPTIONS)'"
	$(MAKE) -f debian/rules DH_OPTIONS=-i binary-common

binary-arch: DH_OPTIONS = -s
binary-arch: install
	@echo "Target $@ invoked in `pwd` with DH_OPTIONS='$(DH_OPTIONS)'"
	$(MAKE) -f debian/rules DH_OPTIONS=-s binary-common

binary: DH_OPTIONS = -i -s
binary:
	@echo "Target $@ invoked in `pwd` with DH_OPTIONS='$(DH_OPTIONS)'"
	$(MAKE) -f debian/rules binary-indep
	case " $(BUILD_CFGOPTIONS) " in (*" --disable-arch "*) exit 0 ;; esac
	$(MAKE) -f debian/rules binary-arch

#
#   Another way that we can be invoked is with a specific package name.  Again,
#   we distinguish between lis and lfs package names.
#

binary-$(PACKAGE_LCNAME)-%: DH_OPTIONS = -p$(PACKAGE_LCNAME)-$*
binary-$(PACKAGE_LCNAME)-%: install
	@echo "Target $@ invoked in `pwd` with DH_OPTIONS='$(DH_OPTIONS)'"
	$(MAKE) -f debian/rules DH_OPTIONS=-p$(PACKAGE_LCNAME)-$* binary-common

get-orig-source:
	wget http://www.openss7.org/tarballs/$(PACKAGE)-$(VERSION).tar.bz

.PHONY: build clean \
	binary-indep binary-arch binary binary-lis binary-lfs binary-indep \
	install-indep install-arch install install-lis install-lfs install-indep \
	get-orig-source

# =============================================================================
# rules.in,v
# Revision 0.9.2.6  2006/07/08 07:23:02  brian
# - clean master deb package build
#
# Revision 0.9.2.5  2006/07/07 21:47:52  brian
# - first full package build on Ubuntu
#
# Revision 0.9.2.4  2006/03/08 11:58:15  brian
# - updates for release
#
# =============================================================================
# vim: ft=make
