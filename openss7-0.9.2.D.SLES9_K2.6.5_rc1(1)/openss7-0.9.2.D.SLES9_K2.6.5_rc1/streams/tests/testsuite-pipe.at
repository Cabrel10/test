dnl vim: ft=config sw=4
dnl ==========================================================================
dnl 
dnl @(#) testsuite-pipe.at,v OpenSS7-0_9_2_D_rc2(0.9.2.8) 2006/03/05 03:51:41
dnl
dnl --------------------------------------------------------------------------
dnl
dnl Copyright (c) 2001-2006  OpenSS7 Corporation <http://www.openss7.com/>
dnl Copyright (c) 1997-2000  Brian F. G. Bidulock <bidulock@openss7.org>
dnl
dnl All Rights Reserved.
dnl
dnl Unauthorized distribution or duplication is prohibited.
dnl
dnl This software and related documentation is protected by copyright and
dnl distributed under licenses restricting its use, copying, distribution
dnl and decompilation.  No part of this software or related documentation
dnl may be reproduced in any form by any means without the prior written
dnl authorization of the copyright holder, and licensors, if any.
dnl
dnl The recipient of this document, by its retention and use, warrants that
dnl the recipient will protect this information and keep it confidential,
dnl and will not disclose the information contained in this document
dnl without the written permission of its owner.
dnl
dnl The author reserves the right to revise this software and documentation
dnl for any reason, including but not limited to, conformity with standards
dnl promulgated by various agencies, utilization of advances in the state
dnl of the technical arts, or the reflection of changes in the design of any
dnl techniques, or procedures embodied, described, or referred to herein.
dnl The author is under no obligation to provide any feature listed herein.
dnl
dnl --------------------------------------------------------------------------
dnl
dnl As an exception to the above, this software may be distributed under the
dnl GNU General Public License (GPL) Version 2, so long as the software is
dnl distributed with, and only used for the testing of, OpenSS7 modules,
dnl drivers, and libraries.
dnl
dnl --------------------------------------------------------------------------
dnl
dnl U.S. GOVERNMENT RESTRICTED RIGHTS.  If you are licensing this Software on
dnl behalf of the U.S. Government ("Government"), the following provisions
dnl apply to you.  If the Software is supplied by the Department of Defense
dnl ("DoD"), it is classified as "Commercial Computer Software" under
dnl paragraph 252.227-7014 of the DoD Supplement to the Federal Acquisition
dnl Regulations ("DFARS") (or any successor regulations) and the Government is
dnl acquiring only the license rights granted herein (the license rights
dnl customarily provided to non-Government users).  If the Software is
dnl supplied to any unit or agency of the Government other than DoD, it is
dnl classified as "Restricted Computer Software" and the Government's rights
dnl in the Software are defined in paragraph 52.227-19 of the Federal
dnl Acquisition Regulations ("FAR") (or any successor regulations) or, in the
dnl cases of NASA, in paragraph 18.52.227-86 of the NASA Supplement to the FAR
dnl (or any successor regulations).
dnl
dnl --------------------------------------------------------------------------
dnl
dnl Commercial licensing and support of this software is available from OpenSS7
dnl Corporation at a fee.  See http://www.openss7.com/
dnl
dnl --------------------------------------------------------------------------
dnl
dnl Last Modified 2006/03/05 03:51:41 by brian
dnl
dnl --------------------------------------------------------------------------
dnl
dnl testsuite-pipe.at,v
dnl Revision 0.9.2.8  2006/03/05 03:51:41  brian
dnl - updated common test suites
dnl
dnl Revision 0.9.2.7  2006/02/22 11:33:20  brian
dnl - recognize --quite flag to test suites
dnl
dnl Revision 0.9.2.6  2005/12/22 07:28:47  brian
dnl - streams testcases must default to LfS case
dnl
dnl Revision 0.9.2.5  2005/12/19 12:45:37  brian
dnl - locking down for release
dnl
dnl Revision 0.9.2.4  2005/11/07 03:11:13  brian
dnl - marked expected LiS failures
dnl
dnl Revision 0.9.2.3  2005/11/01 11:21:20  brian
dnl - updates for testing and documentation
dnl
dnl Revision 0.9.2.2  2005/10/12 09:55:54  brian
dnl - STREAMS-based pipes are also working and tested
dnl
dnl Revision 0.9.2.1  2005/10/11 10:45:53  brian
dnl - STREAMS-based pipes are working on RH 7.2 and FC4
dnl - starting test suites for STREAMS-based pipes
dnl - completed testing of STREAMS-based FIFOs
dnl - updated documentation for FIFOs
dnl
dnl Revision 0.9.2.8  2005/10/10 10:37:25  brian
dnl - FIFOs working nicely and tested.
dnl
dnl Revision 0.9.2.7  2005/09/29 23:08:21  brian
dnl - starting testing of FIFOs
dnl
dnl Revision 0.9.2.6  2005/09/27 10:04:24  brian
dnl - more test cases, runqueues bug
dnl
dnl Revision 0.9.2.5  2005/09/26 10:56:55  brian
dnl - factoring
dnl
dnl Revision 0.9.2.4  2005/06/24 16:58:49  brian
dnl - testsuite as always verbose internally
dnl
dnl Revision 0.9.2.3  2005/06/04 13:40:29  brian
dnl - exit early to get proper return code
dnl
dnl Revision 0.9.2.2  2005/05/30 14:25:55  brian
dnl - packaged standalong test suites
dnl
dnl Revision 0.9.2.1  2005/05/21 07:39:52  brian
dnl - new testsuite organization
dnl
dnl Revision 0.9.2.3  2005/05/20 04:45:39  brian
dnl - updated test suites
dnl
dnl Revision 0.9.2.2  2005/05/15 23:57:20  brian
dnl - update tests
dnl
dnl Revision 0.9.2.1  2005/05/14 23:59:23  brian
dnl - getting autotest up and running
dnl
dnl ==========================================================================

m4_divert_push([DEFAULTS])
at_SMP=
at_MP=
function test_pipe() {
    case "$2" in
    (LIS)
	# LiS crashes on many tests regardless of SMP
	if test :${at_STRCONF_PACKAGE:-LfS} = :LiS
	then
	    cat <<ACEOF >&2
***** WARNING *****
This test causes LiS to hang or crash the kernel on all machine
types and all kernel types.  The testsuite has detected an LiS
system and, therefore, the test is skipped but assumed failed.

LIS IS FULL OF BUGS AND IS DEPRECATED!  PLEASE USE THE OPENSS7
LINUX FAST-STREAMS INSTEAD!  WHATEVER YOU DO, DO NOT REPORT THIS
TEST CASE FAILURE AS A BUG!
***** WARNING *****
ACEOF
	    return 2
	fi
	;;
    (SMP)
	# LiS crashes on many tests under SMP
	if test :${at_STRCONF_PACKAGE:-LfS} = :LiS
	then
	    if test :${at_SMP:-notset} = :notset
	    then
		# crashes on SMP machine
		if (grep -q '^processor[[[:space:]]]*:[[[:space:]]]*[[1-9]]' /proc/cpuinfo >/dev/null 2>&1)
		then
		    at_SMP=yes
		else
		    # crahses on SMP kernel UP machine
		    if (grep -q 'SMP' /proc/sys/kernel/version >/dev/null 2>&1)
		    then
			at_SMP=yes
		    else
			at_SMP=no
		    fi
		fi
	    fi
	    if test :$at_SMP = :yes
	    then
		cat <<ACEOF >&2
***** WARNING *****
This test causes LiS to hang or crash the kernel on all machine
types on SMP kernels.  The testsuite has detected an LiS SMP
system and, therefore, the test is skipped but assumed failed.

LIS IS FULL OF BUGS AND IS DEPRECATED!  PLEASE USE THE OPENSS7
LINUX FAST-STREAMS INSTEAD!  WHATEVER YOU DO, DO NOT REPORT THIS
TEST CASE FAILURE AS A BUG!
***** WARNING *****
ACEOF
		return 2
	    fi
	fi
	;;
    (MP)
	# LiS crashes on more tests on a MP machine
	if test :${at_STRCONF_PACKAGE:=LiS} = :LiS
	then
	    if test :${at_MP:-notset} = :notset
	    then
		# crashes on SMP machine
		if (grep -q '^processor[[[:space:]]]*:[[[:space:]]]*[[1-9]]' /proc/cpuinfo >/dev/null 2>&1)
		then
		    at_MP=yes
		else
		    at_MP=no
		fi
	    fi
	    if test :$at_MP = :yes
	    then
		cat <<ACEOF >&2
***** WARNING *****
This test causes LiS to hang or crash the kernel on MP machine
types on SMP kernels.  The testsuite has detected an LiS MP
system and, therefore, the test is skipped but assumed failed.

LIS IS FULL OF BUGS AND IS DEPRECATED!  PLEASE USE THE OPENSS7
LINUX FAST-STREAMS INSTEAD!  WHATEVER YOU DO, DO NOT REPORT THIS
TEST CASE FAILURE AS A BUG!
***** WARNING *****
ACEOF
		return 2
	    fi
	fi
	;;
    esac
    if test $at_verbose = echo
    then
	options='-vvvvv'
    else
	if test $at_arg_given_quiet != false
	then
	    options='-q'
	else
	    options='-vvv'
	fi
    fi
    if test-pipe $options -e -o $1
    then
	if test :${at_STRCONF_PACKAGE:-LfS} = :LfS
	then
	    # check for leaks
	    if (cat /proc/streams/strinfo | grep -v '000000000000') >&2
	    then
		return 1
	    else
		return 0
	    fi
	else
	    return 0
	fi
    else
	return $?
    fi
}
m4_divert_pop([DEFAULTS])

AT_TESTED([test-pipe])

AT_BANNER([PIPE Test])

AT_SETUP([posix pipe test 1.1])
AT_KEYWORDS([pipe open])
AT_CHECK([test_pipe 1.1], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.1.1])
AT_KEYWORDS([pipe ioctl I_LOOK])
AT_CHECK([test_pipe 2.1.1], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.2.1])
AT_KEYWORDS([pipe ioctl I_RECVFD ENXIO HUP])
AT_CHECK([test_pipe 2.2.1], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.2.2])
AT_KEYWORDS([pipe ioctl I_RECVFD EPROTO RDERR])
AT_CHECK([test_pipe 2.2.2], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.2.3])
AT_KEYWORDS([pipe ioctl I_RECVFD EAGAIN WRERR])
AT_CHECK([test_pipe 2.2.3], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.2.4])
AT_KEYWORDS([pipe ioctl I_RECVFD EPROTO RDERR WRERR])
AT_CHECK([test_pipe 2.2.4], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.2.5])
AT_KEYWORDS([pipe ioctl I_RECVFD])
AT_CHECK([test_pipe 2.2.5], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.2.6])
AT_KEYWORDS([pipe ioctl I_RECVFD EINTR])
AT_CHECK([test_pipe 2.2.6], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.2.7])
AT_KEYWORDS([pipe ioctl I_RECVFD])
AT_CHECK([test_pipe 2.2.7], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.3.1])
AT_KEYWORDS([pipe ioctl I_SENDFD ENXIO HUP])
AT_CHECK([test_pipe 2.3.1 MP], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.3.2])
AT_KEYWORDS([pipe ioctl I_SENDFD RDERR])
AT_CHECK([test_pipe 2.3.2 MP], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.3.3])
AT_KEYWORDS([pipe ioctl I_SENDFD EPROTO WRERR])
AT_CHECK([test_pipe 2.3.3 MP], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.3.4])
AT_KEYWORDS([pipe ioctl I_SENDFD EPROTO RDERR WRERR])
AT_CHECK([test_pipe 2.3.4 MP], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.4.1])
AT_KEYWORDS([pipe ioctl I_PUSH ENXIO HUP])
AT_CHECK([test_pipe 2.4.1 MP], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.4.2])
AT_KEYWORDS([pipe ioctl I_POP ENXIO HUP])
AT_CHECK([test_pipe 2.4.2], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.4.3])
AT_KEYWORDS([pipe ioctl I_FLUSH ENXIO HUP])
AT_CHECK([test_pipe 2.4.3], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.4.4])
AT_KEYWORDS([pipe ioctl I_STR ENXIO HUP])
AT_CHECK([test_pipe 2.4.4], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.4.5])
AT_KEYWORDS([pipe ioctl I_FDINSERT ENXIO HUP])
AT_CHECK([test_pipe 2.4.5], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.4.6])
AT_KEYWORDS([pipe ioctl I_SWROPT ENXIO HUP])
AT_CHECK([test_pipe 2.4.6], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.4.7])
AT_KEYWORDS([pipe ioctl I_FLUSHBAND ENXIO HUP])
AT_CHECK([test_pipe 2.4.7], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 2.4.8])
AT_KEYWORDS([pipe ioctl I_CANPUT ENXIO HUP])
AT_CHECK([test_pipe 2.4.8], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.1.1])
AT_KEYWORDS([pipe write PIPE_BUF])
AT_CHECK([test_pipe 3.1.1], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.1.2])
AT_KEYWORDS([pipe write ~O_NONBLOCK])
AT_CHECK([test_pipe 3.1.2], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.1.3])
AT_KEYWORDS([pipe write ~O_NONBLOCK SIGNAL])
AT_CHECK([test_pipe 3.1.3], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.1.4])
AT_KEYWORDS([pipe write O_NONBLOCK])
AT_CHECK([test_pipe 3.1.4], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.1.5])
AT_KEYWORDS([pipe write O_NONBLOCK <=PIPEBUF])
AT_CHECK([test_pipe 3.1.5], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.1.6])
AT_KEYWORDS([pipe write O_NONBLOCK >PIPEBUF])
AT_CHECK([test_pipe 3.1.6], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.1.7])
AT_KEYWORDS([pipe write zero-length])
AT_CHECK([test_pipe 3.1.7], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.1.8])
AT_KEYWORDS([pipe write ENXIO HUP])
AT_CHECK([test_pipe 3.1.8], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.1.9])
AT_KEYWORDS([pipe write EPROTO SIGPIPE WRERR])
AT_CHECK([test_pipe 3.1.9], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.1.10])
AT_KEYWORDS([pipe write EPROTO RDERR WRERR])
AT_CHECK([test_pipe 3.1.10], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.1.11])
AT_KEYWORDS([pipe write EPIPE SIGPIPE])
AT_CHECK([test_pipe 3.1.11], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.2.1])
AT_KEYWORDS([pipe putmsg PIPE_BUF])
AT_CHECK([test_pipe 3.2.1], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.2.2])
AT_KEYWORDS([pipe putmsg ~O_NONBLOCK])
AT_CHECK([test_pipe 3.2.2], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.2.3])
AT_KEYWORDS([pipe putmsg ~O_NONBLOCK SIGNAL])
AT_CHECK([test_pipe 3.2.3], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.2.4])
AT_KEYWORDS([pipe putmsg O_NONBLOCK])
AT_CHECK([test_pipe 3.2.4], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.2.5])
AT_KEYWORDS([pipe putmsg O_NONBLOCK <=PIPEBUF])
AT_CHECK([test_pipe 3.2.5], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.2.6])
AT_KEYWORDS([pipe putmsg O_NONBLOCK >PIPEBUF])
AT_CHECK([test_pipe 3.2.6], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.2.7])
AT_KEYWORDS([pipe putmsg zero-length])
AT_CHECK([test_pipe 3.2.7], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.2.8])
AT_KEYWORDS([pipe putmsg ENXIO HUP])
AT_CHECK([test_pipe 3.2.8], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.2.9])
AT_KEYWORDS([pipe putmsg EPROTO SIGPIPE WRERR])
AT_CHECK([test_pipe 3.2.9], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.2.10])
AT_KEYWORDS([pipe putmsg EPROTO RDERR WRERR])
AT_CHECK([test_pipe 3.2.10], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.2.11])
AT_KEYWORDS([pipe putmsg EPIPE SIGPIPE])
AT_CHECK([test_pipe 3.2.11], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.3.1])
AT_KEYWORDS([pipe putpmsg PIPE_BUF])
AT_CHECK([test_pipe 3.3.1], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.3.2])
AT_KEYWORDS([pipe putpmsg ~O_NONBLOCK])
AT_CHECK([test_pipe 3.3.2], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.3.3])
AT_KEYWORDS([pipe putpmsg ~O_NONBLOCK SIGNAL])
AT_CHECK([test_pipe 3.3.3], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.3.4])
AT_KEYWORDS([pipe putpmsg O_NONBLOCK])
AT_CHECK([test_pipe 3.3.4], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.3.5])
AT_KEYWORDS([pipe putpmsg O_NONBLOCK <=PIPEBUF])
AT_CHECK([test_pipe 3.3.5], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.3.6])
AT_KEYWORDS([pipe putpmsg O_NONBLOCK >PIPEBUF])
AT_CHECK([test_pipe 3.3.6], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.3.7])
AT_KEYWORDS([pipe putpmsg zero-length])
AT_CHECK([test_pipe 3.3.7], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.3.8])
AT_KEYWORDS([pipe putpmsg ENXIO HUP])
AT_CHECK([test_pipe 3.3.8], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.3.9])
AT_KEYWORDS([pipe putpmsg EPROTO SIGPIPE WRERR])
AT_CHECK([test_pipe 3.3.9], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.3.10])
AT_KEYWORDS([pipe putpmsg EPROTO RDERR WRERR])
AT_CHECK([test_pipe 3.3.10], [], [ignore], [], [], [])
AT_CLEANUP

AT_SETUP([posix pipe test 3.3.11])
AT_KEYWORDS([pipe putpmsg EPIPE SIGPIPE])
AT_CHECK([test_pipe 3.3.11], [], [ignore], [], [], [])
AT_CLEANUP

